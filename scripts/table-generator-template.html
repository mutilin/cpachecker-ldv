<!DOCTYPE HTML>

<html>
<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<style type="text/css">
    <!--
    table { outline:3px solid black; border-spacing:0px; font-family:arial, sans serif}
    thead { text-align:center}
    tbody { text-align:right}
    tfoot { text-align:center}
    tr:hover { background-color:yellow}
    td { border:1px solid black}
    td:first-child { text-align:left; white-space:nowrap}
    tbody td:first-child { font-family: monospace; }
    #options td:not(:first-child) {  text-align:left; font-size: x-small;
                                     font-family: monospace; }
    #columnTitles td:first-child { font-family: monospace; font-size: x-small; }
    tbody tr:first-child td { border-top:3px solid black}
    tfoot tr:first-child td { border-top:3px solid black}
    .correctSafe, .correctUnsafe { text-align:center; color:green}
    .wrongSafe, .wrongUnsafe { text-align:center; color:red; font-weight: bold; }
    .unknown { text-align:center; color:orange; font-weight: bold; }
    .error { text-align:center; color:magenta; font-weight: bold; }
    .score { text-align:center; font-size:large; font-weight:bold; }
    a { color: inherit; text-decoration: none; display: block; } 
    a:hover, .clickable:hover { background: lime; cursor: pointer; }

    #contentPaneBackground { height:5000px; width:5000px;
             position:fixed; top:0px; left:0px;
             background-image: url(http://www.house-events.de/schnee.gif);
             background-color:grey; 
             opacity:0.5; display:none }
    #contentPane { height:90%; width:90%; position:fixed; top:5%; left:5%;
             border:solid 10px black; border-radius:15px;
             background-color:white; opacity:1; display:none }
	-->
</style>


<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery-1.7.1.min.js"></script>


<script type="text/javascript">
function debug(logInfo) {
  if(!true) {
    console.log(logInfo);
  }
}

function showContentPane() {
    // add function for cleanup, first unbind any old function
    $('#contentPaneBackground').unbind().click(hideContentPane).show();
    $('#contentPane').keydown(hideContentPane);
    $('#contentPane').show().focus();
}

function hideContentPane(event) {
	// hide the content pane on mouse click outside the content pane
	// or when pressing the "Esc" or "c" key with the content pane focused
    if(event.type == "click" || escKeyPressed(event) || cKeyPressed(event)) {
      $('#contentPaneBackground').hide();
      $('#contentPane').hide().empty();
  }
}

function escKeyPressed(event) {
	return event.keyCode == 27;
}

function cKeyPressed(event) {
	// only "c" is pressed, not in combination with Ctrl-key
	return (event.keyCode == 67 && event.ctrlKey == false);
}

var headerArray = [];

function createHeaderArray() {
    if (headerArray.length != 0) { return; } // headerArray already filled

    var tableHead = $("#dataTable > thead")[0];
    for (var i=0; i<tableHead.rows.length; i++) {
        var rowIndices = expandColSpanToNums(tableHead.rows[i]);
        headerArray.push(rowIndices);
    }
}

function expandColSpanToNums(row) {
    var list = [];
    for (var i=0; i<row.cells.length; i++) {
      for (var j=0; j<parseInt(row.cells[i].colSpan); j++) {
        list.push(i);
      }
    }
    return list;
}

$(document).ready(function(){
    createHeaderArray();
});
</script>


<script type="text/javascript">
// this section contains functions for loading urls 
// and showing the content in the contentPane.

function loadContentWrapper(event) {
    var url = $(event.target).attr("href");
    loadContent(url);
    return false;
}

function loadContent(url) {
    var contentPane = $("<pre>").appendTo("#contentPane")
            .css("width", "100%").css("height", "100%")
            .css("margin", "0").css("overflow", "auto");

    $.ajax({
        async: false, // wait for isError
        url: url,
        cache: false,
        dataType: "text",
        beforeSend: function() {
            showContentPane();
            contentPane.html("loading...");
        },
        success: function(text){
            newtext = text.replace(/&/g, "&amp;")
                          .replace(/"/g, "&quot;")
                          .replace(/</g, "&lt;")
                          .replace(/>/g, "&gt;")
                          .replace(/\\n/g, "<br>");
            contentPane.html(newtext);
        },
        error: function() {
            contentPane.html("error while loading content.<br>" +
            "this could be a problem of the 'same-origin-policy' of your browser.<br><br>" + 
            "only firefox seems to be able to access files from local directories<br>" + 
            "and this works only if the file is in the same directory as this website.<br><br>" + 
            "you can try to download the file: <a href=" + url + ">" + url + "</a>");
        },
    });
}

$(document).ready(function(){
    var cellsWithUrls = $('a');
    //console.log(cellsWithUrls);
    cellsWithUrls.each(
        function(index, elem){
            $(elem).click(loadContentWrapper);
        });
});
</script>


<style type="text/css">
    #toggleButtons ul { font-family:arial, sans serif; }
    #toggleButtons ul li { display: inline; }
    #toggleButtons ul li:hover { background-color:yellow; }
</style>


<script type="text/javascript">
// this section contains functions for toggling columns in the table.

function incColspan(col) {
    var span = parseInt(col.attr("colspan"));
    if (span == 0) { col.show(); }
    col.attr("colspan", span + 1);
}

function decColspan(col) {
    var span = col.attr("colspan");
    span = (span == undefined) ? 1 : parseInt(span);
    col.attr("colspan", span - 1);
    if (span == 1) { col.hide(); }
}

// this function shows or hides a column and enlarges or shrinkes the header-columns
// @param index: index of a column in row "columnTitle"
function toggleColumn (button, index) {
    for (var i=0; i<headerArray.length; i++) {
        var cell = $("#dataTable > thead > tr:eq(" + i + ") > td:eq(" + headerArray[i][index] + ")");
        button.checked ? incColspan(cell) : decColspan(cell);
    }
    var childIndex = index+1; // first child is number 1
    var children = $("tbody > tr > td:nth-child(" + childIndex + "), " +
                     "tfoot > tr > td:nth-child(" + childIndex + ")");
    button.checked ? children.show() : children.hide();
}


// we use a cache, because it is difficult to calculate the 
// colspan of headerrows with some hidden columns
var buttonListCache = null;


function createColumnToggleButtons() {
    if (buttonListCache == null) { // if not cached, for details see 5 lines above

        var tableHead = $("#dataTable > thead")[0];
        var columnTitles = $("#columnTitles > td");
        var testNums = headerArray[4];
        var testNum = testNums[1];
        var testName = tableHead.children[3].cells[headerArray[3][1]].textContent + " " + 
                       tableHead.children[4].cells[testNum].textContent;
    
        // TODO can we make next block more OO-like?
        buttonList = '<ul>' + testName;
        for (var i=1; i<columnTitles.length; i++) { // do not use first column (i!=0)
            if (testNum != testNums[i]) {
                testNum = testNums[i];
                testName = tableHead.children[3].cells[headerArray[3][i]].textContent + " " + 
                           tableHead.children[4].cells[testNum].textContent;
                buttonList += '</ul><ul>' + testName;
            }
    
            var toggleFunction = 'onclick="toggleColumn(this,' + i + ')"';
    
            var column = columnTitles[i];
            var button = '<input type="checkbox" id="check' + i + '" ' + toggleFunction + ' checked>';
            var label = '<label for="check' + i + '">' + column.textContent + '</label>';
            buttonList += '<li>' + button + label + '</li>';
        }
        buttonList += '</ul>';
        buttonListCache = $(buttonList);
    }

    $('<form id="toggleButtons" onsubmit="return false"></form>')
        .append(buttonListCache)
        .appendTo($("#contentPane"));
    showContentPane();
}

function createRowFilterButtons() {
    var tableHead = $("#dataTable > thead")[0];
    var columnTitles = $("#columnTitles > td");
    var testNums = headerArray[4];
    var testNum = testNums[1];
    var testName = tableHead.children[3].cells[headerArray[3][1]].textContent + " " + 
		    tableHead.children[4].cells[testNum].textContent;

    // TODO can we make next block more OO-like?
    buttonList = '<ul>' + testName;
    for (var i=1; i<columnTitles.length; i++) { // do not use first column (i!=0)
	if (testNum != testNums[i]) {
	    testNum = testNums[i];
	    testName = tableHead.children[3].cells[headerArray[3][i]].textContent + " " + 
			tableHead.children[4].cells[testNum].textContent;
	    buttonList += '</ul><ul>' + testName;
	}

	var toggleFunction = 'onclick="fillRowFilterField(this,' + i + ')"';

	var column = columnTitles[i];
	var button = '<input type="radio" name="filter" id="check' + i + '" ' + toggleFunction + '>';
	var label = '<label for="check' + i + '">' + column.textContent + '</label>';
	buttonList += '<li>' + button + label + '</li>';
    }
    buttonList += '</ul>';
    buttonList += '<select id="rowfilterSelect"><option value="none">none</option></select>';
    buttonList = $(buttonList);

    $('<form id="filterButtons" onsubmit="return false"></form>')
        .append(buttonList)
        .appendTo($("#contentPane"));
    showContentPane();
}

function fillRowFilterField (button, columnIndex) {

    var rowfilter = $('#rowfilterSelect');
    var rowfilterSelect = rowfilter[0];

    // clear all but default option
    for(var i = rowfilterSelect.options.length - 1; i > 0; i--) {
      rowfilterSelect.options.remove(i);
    }

    // determin new options
    var dataRows = $('#dataTable > tbody')[0].rows;
    var options = new Array();
    for(var i = 0; i < dataRows.length; i++) {
      currentValue = dataRows[i].cells[columnIndex].textContent;
      if(jQuery.inArray(currentValue, options) === -1)
	options[options.length] = currentValue;
    }

    // add new options
    for(var i = 0; i < options.length; i++) {
	newOption = document.createElement('option');
	newOption.value = options[i];
	newOption.text = options[i];
	
	rowfilterSelect.options.add(newOption, null);
    }

    rowfilter.unbind().on('change', {column: columnIndex}, filterRows);
}

function filterRows(event) {
  var rowfilterSelect = $('#rowfilterSelect')[0];
  selectedValue = rowfilterSelect.value;
  columnIndex = event.data.column;

  columnName = $('#columnTitles')[0].cells[columnIndex].textContent;

  var dataRows = $('#dataTable > tbody')[0].rows;
  for(var i = 0; i < dataRows.length; i++) {
    $(dataRows[i]).show();
    if(selectedValue != dataRows[i].cells[columnIndex].textContent) {
      $(dataRows[i]).hide();
    }
  
    else if(columnName == 'status' && dataRows[i].cells[columnIndex].className.indexOf('wrong') == 0){
      $(dataRows[i]).hide();
    }
  }
  
  $('#contentPaneBackground').hide();
  $('#contentPane').hide().empty();
}

$(document).ready(function(){
    $('#columnTitles > td:first-child')
        .addClass("clickable")
        .click(function (event) { 
            return createColumnToggleButtons(); });

    $('body').keydown(function (event) {
			    if(event.keyCode == 70)
			      return createRowFilterButtons(); 
			  });
});
</script>


<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jquery.jqplot.min.js"></script>
<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jqplot.highlighter.min.js"></script>
<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jqplot.cursor.min.js"></script>
<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jqplot.canvasTextRenderer.min.js"></script>
<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jqplot.canvasAxisTickRenderer.min.js"></script>
<script type="text/javascript" src="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jqplot.enhancedLegendRenderer.min.js"></script>
<link rel="stylesheet" type="text/css" href="http://www.sosy-lab.org/lib/jquery.jqplot-1.0.0b2_r1012/jquery.jqplot.min.css"/>

<style type="text/css">
    .jqplot-title {font-family:arial, sans serif; font-size:large }
    .jqplot-table-legend-swatch {width:20px; height:15px }
    .jqplot-table-legend { border-style:none; outline:none }
    .jqplot-table-legend tbody { border-style:none }
    .jqplot-table-legend tbody tr td { border-top:none; cursor:pointer }
    .jqplot-highlighter-tooltip {font-family:arial, sans serif; font-size:large;
             border:solid 1px black; padding:2px;
             border-radius:8px; border-bottom-left-radius:0px;
             background-color:white; opacity:0.8; }
    #chart { height:100%; width:100% }
    #button-trend { position:absolute; bottom:0px; }
</style>

<script type="text/javascript">

// this function collects the indices of columns with title "header"
function getColumnIndicesForHeader(header) {
    var columnIndizes = [];
    var cells = document.getElementById('columnTitles').cells;

    for(i = 0; i < cells.length; i++) {
      var currentHeader = cells[i].textContent;
      if (currentHeader == header) {
        columnIndizes.push(i);
      }
    }

    return columnIndizes;
};

// getTableData returns a list of arrays, 
// each array is of the form: [[file1, value1], [file2, value1], ...]
function getTableData(header) {
    debug("data for: " + header);
    var data = [];

    var indices = getColumnIndicesForHeader(header);
    for (j = 0; j < indices.length; j++) {
      data.push([]);
    }

    var tableBody = $('#dataTable > tbody')[0];

    for(i = 0; i < tableBody.rows.length; i++) {
      var currentRow = tableBody.rows[i];

      if(!$(currentRow).is(":visible")) {
	continue;
      }

      for (j = 0; j < indices.length; j++) {
        var index = indices[j];
        var currentCell = currentRow.cells[index];

        var value;
        if (header === 'status') {
            if (currentCell.className.indexOf('correct') == 0)     value = 1;
            else if (currentCell.className.indexOf('wrong') == 0)  value = 0;
            else                                                  value = -1;
        } else {
          value = parseFloat(currentCell.textContent)
        }
        data[j].push([i, value]);
      }
    }

    debug(data);
    return function inner(){ return data;};
};


// this method returns sorted data for showTrend().
function sortData(data) {
    var newData = [];
    for (i = 0; i < data.length; i++) {
        var line = data[i];
        var array = [];

        for (j = 0; j < line.length; j++) {
            if (line[j].length != 2) {debug("ERROR: data is invalid!");}
            array.push(line[j][1]);
        }

        array.sort( function(a, b) { return a - b;} ); // compare numbers!

        var newLine = [];
        for (j = 0; j < line.length; j++) {
            newLine.push([j, array[j]]);
        }

        newData.push(newLine);
    }
    return function inner(){ return newData;};
}

// get labels for x-direction
function getXTicks(){
    var xTicks = [];
    var maxLength = 40;
    var tableBody = $('#dataTable > tbody')[0];
    for(i = 0; i < tableBody.rows.length; i++) {
      var name = tableBody.rows[i].cells[0].textContent;
      if (name.length > maxLength) { name = name.substring(0, maxLength) + "..."; }
      xTicks.push([i, name]);
    }
    return xTicks;
}

// get labels for x-direction as [[0," 0"],[1," "],...] with a number in each 5th element
function getXTicksWithNumbers(){
    var xTicks = [];
    var maxLength = 40;
    var tableBody = $('#dataTable > tbody')[0];
    for(i = 0; i < tableBody.rows.length; i++) {
      xTicks.push([i, ((i%5)?" ":" " + i)]);
    }
    return xTicks;
}

// get labels for y-direction
function getYTicks(header) {
    if (header == "status") {
      return [[-1.5, " "], [-1, "wrong"], [0, "unknown"], [1, "correct"], [1.5, " "]];
    } else {
      return [];
    }
}

// returns label of a test: 'tool+test+date'.
function getLabels(header) {
    debug("labels for: " + header);
    var labels = [];

    var indices = getColumnIndicesForHeader(header);
    var tableHead = $('#dataTable > thead')[0];
    var tool = 0;  // rowindex for tool, date, test
    var date = 3;
    var test = 4;
    for (i = 0; i < indices.length; i++) {
        var index = indices[i];
        labels.push(tableHead.rows[tool].cells[headerArray[tool][index]].textContent + " " +
                    tableHead.rows[date].cells[headerArray[date][index]].textContent + " " +
                    tableHead.rows[test].cells[headerArray[test][index]].textContent);
    }
    return labels;
};


function addLegendActions() {
    var legendButtons = $('tr.jqplot-table-legend');
    var seriesLines = $('canvas.jqplot-series-canvas');

    // assertion
    if (legendButtons.length != seriesLines.length) {
        debug("ERROR: number of series does not match buttons!");
    }

    for (i = 0; i<legendButtons.length; i++) {
      var currentButton = legendButtons[i];
      var currentLine = seriesLines[i];

      currentButton.onclick = function(event) {
        var hideOpacity = 0.3;
        if (this.style.opacity == hideOpacity) {
            this.style.opacity = 1;
        } else {
            this.style.opacity = hideOpacity;
        }
      }

      currentButton.onmouseover = function(line) {
        return function(event){ line.style.zIndex = 5; }
      }(currentLine);

      currentButton.onmouseout = function(line) {
        return function(event){ line.style.zIndex = 0; }
      }(currentLine);
    }
}


function showPlot(header) {
    debug("show plot of: " + header);
    $('#contentPaneBackground').trigger('click');

    var yTicks = getYTicks(header);
    var xTicks = getXTicks(); // filenames for labels
    var data = getTableData(header);

    drawPlot(header, data, xTicks, yTicks, "plot");

    var button = $('#button-trend')[0];
    button.onclick = function() { showTrend(header); };
    button.textContent = 'Show Trend';
};


function showTrend(header) {
    debug("show trend of: " + header);
    $('#contentPaneBackground').trigger('click');

    var yTicks = getYTicks(header);
    var xTicks = getXTicksWithNumbers();
    var data = sortData(getTableData(header)());

    drawPlot(header, data, xTicks, yTicks, "trend");

    var button = $('#button-trend')[0];
    button.onclick = function() { showPlot(header); };
    button.textContent = 'Show Plot';
};


function getFormatter(labels, header) {
    return function(str, seriesIndex, pointIndex){
        debug(str, seriesIndex, pointIndex);
        var filename = labels[pointIndex][1];
        if (header == "status") {
            if (str == 1)       str = "correct";
            else if (str == 0)  str = "unknown";
            else                str = "wrong";
        }
        if (filename.indexOf(" ") == 0) { // for showTrend(), all labels start with space.
            filename = "";
        } else {
            filename = filename + "<br>";
        }
        return filename + str;
    };
}

function drawPlot(header, data, xTicks, yTicks, type) {
    $('#contentPane').append('<div id="chart"></div>',
                   '<button id="button-trend"></button>');

    showContentPane();
    $('#contentPaneBackground').click(function(event){
        $('#chart').empty();
    });

        // data array is empty, we use "columnRenderer" option to get data.
        var plot = $.jqplot('chart',[],{
          title: header,
          legend: {
            show:true,
            placement: 'outsideGrid',
            renderer: $.jqplot.EnhancedLegendRenderer,
            labels: getLabels(header),
            location: 's',
            rowSpacing: "0px",
            showSwatches: true,
          },
          dataRenderer: data,
          highlighter:{
            show: true,
            sizeAdjust: 10,
            showMarker: true,
            tooltipAxes: 'y',
            tooltipLocation: 'ne',
            tooltipContentEditor: getFormatter(xTicks, header),
          },
          seriesDefaults:{
            shadow: false,
          },
          cursor:{
            show: false,
            zoom: false,
            showTooltip: false,
          },
          axes:{
            xaxis:{
              ticks: xTicks,
              tickRenderer: $.jqplot.CanvasAxisTickRenderer,
              tickOptions: {
                fontSize: '9px',
                angle: -60,
              }
            },
            yaxis:{
              ticks: yTicks,
              pad: 1.2,
              tickOptions:{
                formatString:'%.2f'
              }
            }
          },
        });

    addLegendActions();
};


// this function adds the listeners to the table
$(document).ready(function(){
    var columnTitles = $('#columnTitles > td');
    for (i = 1; i< columnTitles.length; i++) { // do not use first column (i!=0)
      var column = columnTitles[i];
      debug(column);
      column.style.cursor = "pointer";
      column.onclick = function (event) {
          var header = event.target.textContent;
          return showPlot(header);
      }
    }
});

</script>

<title>{{{title}}}</title>

</head>

<body>

<div id="contentPaneBackground"></div>
<div id="contentPane" tabindex="0"></div>

<table id="dataTable">
{{{table}}}
</table>

</body>

</html>
