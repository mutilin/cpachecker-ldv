<?xml version="1.0" encoding="UTF-8" ?>
<!-- vim: set tabstop=8 shiftwidth=4 expandtab filetype=ant : -->
<project name="AutomatonParserGeneration" default="generate-parser" basedir="./../../../../../../">
    <!-- basedir should be the "CPAchecker" directory -->
    <property name="parserDir" location="src/org/sosy_lab/cpachecker/cpa/automaton/" />
    <property name="src" location="src" />
    <property name="lib" location="lib" />
    <property environment="env" />

    <taskdef name="jflex"
        classname="JFlex.anttask.JFlexTask"
        classpath="${lib}/build-only/JFlex.jar"
    />
    <taskdef name="cup"
        classname="java_cup.anttask.CUPTask"
        classpath="${lib}/java-cup-11a.jar"
    />

    <target name="echos">
        <echo>${lib}</echo>
        <echo>${src}</echo>
        <echo>${parserDir}</echo>
        <echo>${basedir}</echo>
    </target>

    <target name="clean" description="Delete generated files">
        <delete>
            <fileset dir="${parserDir}" includes="AutomatonScanner.java AutomatonParser.java AutomatonSym.java"/>
        </delete>
    </target>

    <uptodate property="scanner.uptodate" srcfile="${parserDir}/Scanner.jflex" targetfile="${parserDir}/AutomatonScanner.java"/>

    <condition property="parser.uptodate">
        <and>
            <isset property="scanner.uptodate"/>
            <uptodate srcfile="${parserDir}/parser.cup" targetfile="${parserDir}/AutomatonParser.java"/>
        </and>
    </condition>

    <target name="generate-scanner" unless="scanner.uptodate" description="Generate automaton scanner">
        <echo message="Generate scanner..." level="info"/>
        <jflex file="${parserDir}/Scanner.jflex" destdir="${src}" skel="${parserDir}/skeleton.nested"/>

        <!-- remove generation date to not interfere with SVN -->
        <replaceregexp file="${parserDir}/AutomatonScanner.java" match="\d\d\.\d\d.\d\d \d\d:\d\d" replace="[date omitted]" flags="g" />
        <replaceregexp file="${parserDir}/AutomatonScanner.java" match="(.tt>).*/(src/org/sosy_lab/cpachecker/cpa/automaton/Scanner.jflex./tt>)" replace="\1\2" />
    </target>

    <target name="generate-parser" depends="generate-scanner" unless="parser.uptodate" description="Generate automaton parser">
        <echo message="Generate parser..." level="info"/>
        <cup srcfile="${parserDir}/parser.cup"
            destdir="${src}"
            interface="true"
            parser="AutomatonParser"
            symbols="AutomatonSym"
            nopositions="true"
        />

        <!-- remove generation date to not interfere with SVN -->
        <replaceregexp match="(Mon|Tue|Wed|Thu|Fri|Sat|Sun) \w\w\w \d\d \d\d:\d\d:\d\d \w+ \d\d\d\d" replace="[date omitted]" flags="g">
            <fileset dir="${parserDir}">
                <include name="AutomatonParser.java"/>
                <include name="AutomatonSym.java"/>
            </fileset>
        </replaceregexp>

        <!-- places the suppressWarnings-tag in front of the outer class -->
        <replace file="${parserDir}/AutomatonParser.java" token="public class " value="@SuppressWarnings(value = { &quot;all&quot; }) public    class "/>
        <!-- places the suppressWarnings-tag in front of the inner class -->
        <replace file="${parserDir}/AutomatonParser.java" token="class CUP$" value="@SuppressWarnings(value = { &quot;all&quot; }) class    CUP$"/>
        <!-- SVN had "inconsistent line endings"-Problems. Let ANT fix it, uses the system default line ending -->
        <fixcrlf file="${parserDir}/AutomatonParser.java" />
    </target>
</project>
