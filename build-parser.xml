<?xml version="1.0" encoding="UTF-8" ?>
<!-- vim: set tabstop=8 shiftwidth=4 expandtab filetype=ant : -->
<project name="Base script for parser generation" default="generate-parser" basedir=".">
    <!-- basedir should be the "CPAchecker" directory -->
    <dirname property="dir.base" file="${ant.file.imported}"/>
    <property name="dir.src" location="${dir.base}/src" />
    <property name="dir.lib" location="${dir.base}/lib/java/build" />

    <!-- the following properties will be used as default
         if the importing file does not overwrite them -->
    <property name="scanner.source" value="Scanner.jflex"/>
    <property name="skeleton.source" value="skeleton.nested"/>
    <property name="parser.source" value="parser.cup"/>

    <taskdef name="jflex"
        classname="JFlex.anttask.JFlexTask"
        classpath="${dir.lib}/jjlex.jar"
    />
    <taskdef name="cup"
        classname="java_cup.anttask.CUPTask"
        classpath="${dir.lib}/java-cup.jar"
    />

    <target name="echos">
        <echo>${dir.base}</echo>
        <echo>${dir.lib}</echo>
        <echo>${dir.src}</echo>
        <echo>${dir.parser}</echo>
    </target>

    <target name="clean" description="Delete generated files">
        <delete>
            <fileset dir="${dir.parser}" includes="${scanner.target}.java ${parser.target}.java ${symbols.target}.java"/>
        </delete>
    </target>

    <uptodate property="scanner.uptodate" srcfile="${dir.parser}/${scanner.source}" targetfile="${dir.parser}/${scanner.target}.java"/>

    <condition property="parser.uptodate">
        <and>
            <isset property="scanner.uptodate"/>
            <uptodate srcfile="${dir.parser}/${parser.source}" targetfile="${dir.parser}/${parser.target}.java"/>
        </and>
    </condition>

    <target name="generate-scanner" unless="scanner.uptodate" description="Generate automaton scanner">
        <echo message="Generate scanner..." level="info"/>
        <jflex file="${dir.parser}/${scanner.source}" destdir="${dir.src}" skel="${dir.parser}/${skeleton.source}"/>

        <!-- remove generation date to not interfere with SVN -->
        <replaceregexp file="${dir.parser}/${scanner.target}.java" match="\d\d\.\d\d.\d\d \d\d:\d\d" replace="[date omitted]" flags="g" />
        <replaceregexp file="${dir.parser}/${scanner.target}.java" match="(.tt>).*/(${scanner.source}./tt>)" replace="\1\2" />
    </target>

    <target name="generate-parser" depends="generate-scanner" unless="parser.uptodate" description="Generate automaton parser">
        <echo message="Generate parser..." level="info"/>
        <cup srcfile="${dir.parser}/${parser.source}"
            destdir="${dir.src}"
            interface="true"
            parser="${parser.target}"
            symbols="${symbols.target}"
            nopositions="true"
        />

        <!-- remove generation date to not interfere with SVN -->
        <replaceregexp match="(Mon|Tue|Wed|Thu|Fri|Sat|Sun) \w\w\w \d\d \d\d:\d\d:\d\d \w+ \d\d\d\d" replace="[date omitted]" flags="g">
            <fileset dir="${dir.parser}">
                <include name="${parser.target}.java"/>
                <include name="${symbols.target}.java"/>
            </fileset>
        </replaceregexp>

        <!-- places the suppressWarnings-tag in front of the outer class -->
        <replace file="${dir.parser}/${parser.target}.java" token="public class " value="@SuppressWarnings(value = { &quot;all&quot; }) public    class "/>
        <!-- places the suppressWarnings-tag in front of the inner class -->
        <replace file="${dir.parser}/${parser.target}.java" token="class CUP$" value="@SuppressWarnings(value = { &quot;all&quot; }) class    CUP$"/>
        <!-- SVN had "inconsistent line endings"-Problems. Let ANT fix it, uses the system default line ending -->
        <fixcrlf file="${dir.parser}/${parser.target}.java" />
    </target>
</project>
